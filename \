import sys
import discord
from typing import Mapping, Optional, Any, List
from discord.ext import commands

class Help(commands.HelpCommand):
    def footer(self):
        return (f"!{self.invoked_with} "
                f"[command] for more information.")

    def get_command_signature(self, command: commands.Command):
        return (f"```!{command.qualified_name} "
                f"{command.signature}```")

    async def send_bot_help(
            self,
            mapping: Mapping[Optional[commands.Cog],
                             List[commands.Command[Any, ..., Any]]

                             ]
            ) -> None:
        embed = discord.Embed(
                title="Alpine Bot Commands", 
                color=discord.Color.blue()
                )
        embed.description = self.context.bot.description
        for cog, commands in mapping.items():
            if (not cog) or (cog.qualified_name == "HelpCog"):
                continue

            filtered_commands = await self.filter_commands(commands, sort=True)
            if (filtered_commands):
                value = "\t".join(f"`{i.name}`" for i in commands)
                embed.add_field(
                        name=cog.qualified_name, 
                        value=value, 
                        inline=False
                        )

        embed.set_footer(text=self.footer())
        await self.get_destination().send(embed=embed)

    async def send_cog_help(self, cog: commands.Cog) -> None:
        embed = discord.Embed(
                title=f"{cog.qualified_name} commands", 
                color=discord.Color.blue()
                )
        embed.description = cog.description
        filtered_commands = await self.filter_commands(
                cog.get_commands(), 
                sort=True
                )
        for command in filtered_commands:
            embed.add_field(
                    name=command.qualified_name,
                    value=command.brief,
                    inline=False
                    )

        embed.set_footer(text=self.footer())
        await self.get_destination().send(embed=embed)

    async def send_group_help(
            self, 
            group: commands.Group[Any, ..., Any]
            ) -> None:
        embed = discord.Embed(
                title=f"{group.qualified_name} commands", 
                color=discord.Color.blue()
                )
        embed.description = group.help
        for command in group.commands:
            embed.add_field(
                    name=command.qualified_name,
                    value=command.brief,
                    inline=False
                    )

        embed.set_footer(text=self.footer())
        await self.get_destination().send(embed=embed)

    async def send_command_help(self, command: commands.Command) -> None:
        embed = discord.Embed(
                title=command.qualified_name, 
                color=discord.Color.blue()
                )
        embed.description = command.help
        embed.add_field(
                name="Signature", 
                value=self.get_command_signature(command),
                inline=False
                )
        for param in command.clean_params.values():
            embed.add_field(
                    name=param.name,
                    value=param.description,
                    inline=False
                    )

        embed.set_footer(text=self.footer())
        await self.get_destination().send(embed=embed)

class HelpCog(commands.Cog):
    def __init__(self, bot: commands.Bot) -> None:
        self.bot = bot
        self._help_command = Help()
        self._help_command.cog = self
        self._original_help_command = bot.help_command
        bot.help_command = self._help_command
        bot.help_command.add_check(self.in_db)

    @staticmethod
    async def in_db(ctx: commands.Context) -> bool:
        db = sqlite3.connect(
                "/root/discord-bot/db/alpine-bot.db", 
                check_same_thread=False
                )
        db.execute("PRAGMA FOREIGN_KEYS = ON")
        cursor = db.cursor()
        if isinstance(ctx.channel, discord.channel.DMChannel):
            get_records = (
            """
            SELECT *
            FROM Users 
            """
            )
            user_records = cursor.fetchall()
            db.close()
            lambda pull_singleton = lambda x : x[0]
            users = tuple(map(pull_singleton, user_records))
            return ctx.author.id in users 

        else:
            get_records = (
            """
            SELECT *
            FROM Channels 
            """
            )
            channel_records = cursor.fetchall()
            db.close()
            lambda pull_singleton = lambda x : x[0]
            channels = tuple(map(pull_singleton, channel_records))
            return ctx.channel.id in channels 

    def cog_unload(self) -> None:
        self.bot.help_command = self._original_help_command

async def setup(bot: commands.Bot) -> None:
    await bot.add_cog(HelpCog(bot))
